<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LiveKit Video Room</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    header { background: #333; color: white; padding: 1rem; text-align: center; }
    main { padding: 1rem; }
    input, button { padding: 0.5rem; margin: 0.25rem; }
    video { width: 300px; height: auto; background: black; margin: 0.25rem; }
    .videos { display: flex; flex-wrap: wrap; }
  </style>
</head>
<body>
  <header>
    <h1>LiveKit Test Client</h1>
  </header>
  <main>
    <div>
      <label>Room:</label>
      <input id="roomName" type="text" value="test-room">
      <label>Name:</label>
      <input id="participantName" type="text" value="guest">
      <button id="joinBtn">Join Room</button>
    </div>
    <div class="videos" id="videoContainer"></div>
  </main>

  <!-- LiveKit JS SDK -->
  <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
  <script>
    const { connect, RoomEvent } = window.LivekitClient;
    const joinBtn = document.getElementById('joinBtn');
    const videoContainer = document.getElementById('videoContainer');

    function addVideoTrack(track, participant) {
      const videoEl = document.createElement('video');
      videoEl.autoplay = true;
      videoEl.playsInline = true;
      track.attach(videoEl);
      videoContainer.appendChild(videoEl);

      track.onEnded = () => {
        videoEl.remove();
      };
    }

    joinBtn.addEventListener('click', async () => {
      const roomName = document.getElementById('roomName').value;
      const participantName = document.getElementById('participantName').value;

      try {
        // Fetch token from your token server
        const resp = await fetch(/token?room=${roomName}&username=${participantName});
        const data = await resp.json();
        const token = data.token;

        // Connect to LiveKit
        const room = await connect("ws://77.246.103.197:7880", token);

        // Publish local tracks (camera + mic)
        const tracks = await window.LivekitClient.createLocalTracks({ audio: true, video: true });
        tracks.forEach(track => {
          room.localParticipant.publishTrack(track);
          addVideoTrack(track, room.localParticipant);
        });

        // Handle new participants
        room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
          if (track.kind === 'video') {
            addVideoTrack(track, participant);
          }
        });

        room.on(RoomEvent.TrackUnsubscribed, (track) => {
          track.detach().forEach(el => el.remove());
        });

      } catch (err) {
        console.error("Error joining room:", err);
        alert("Failed to join room: " + err.message);
      }
    });
  </script>
</body>
</html>