<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LiveKit Video Chat</title>
    <style>
        body { font-family: Arial, sans-serif; background: #222; color: #fff; }
        #videoContainer { display: flex; flex-wrap: wrap; gap: 10px; }
        .participant-wrapper {
            position: relative;
            background: #000;
            padding: 5px;
            border-radius: 6px;
        }
        video { width: 300px; height: 200px; background: #000; }
        .name-tag {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0,0,0,0.5);
            padding: 2px 5px;
            font-size: 14px;
            border-radius: 3px;
        }
        button { margin: 5px; padding: 8px 12px; }
    </style>
</head>
<body>
    <h2>LiveKit Video Chat</h2>
    <label>
        Room:
        <input type="text" id="roomSelect" placeholder="Enter room name">
    </label>
    <br>
    <button onclick="joinRoom()">Join Room</button>
    <button onclick="disconnectRoom()">Disconnect</button>
    <button onclick="toggleMute()" id="muteBtn">Mute</button>
    <div id="roomMessage"></div>
    <div id="videoContainer"></div>

    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    <script>
        let currentRoom;
        let isMuted = false;

        async function joinRoom() {
            const roomName = document.getElementById('roomSelect').value;
            if (!roomName) throw new Error('Please enter a room name');

            document.getElementById('videoContainer').innerHTML = '';

            const response = await fetch(`/token?room=${encodeURIComponent(roomName)}`, { credentials: 'include' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Failed to get access token');

            currentRoom = new window.LivekitClient.Room();

            // 1️⃣ Connect first
            await currentRoom.connect(data.url, data.token);

            // 2️⃣ Listeners for new participants
            currentRoom.on(window.LivekitClient.RoomEvent.ParticipantConnected, participant => {
                console.log('Participant connected:', participant.identity);
                subscribeToParticipantTracks(participant, false);
            });

            // 3️⃣ Listeners for disconnection
            currentRoom.on(window.LivekitClient.RoomEvent.ParticipantDisconnected, participant => {
                console.log('Participant disconnected:', participant.identity);
                removeParticipantTracks(participant);
            });

            // 4️⃣ Handle already connected participants
            currentRoom.participants.forEach(p => {
                console.log('Existing participant after connect:', p.identity);
                subscribeToParticipantTracks(p, false);
            });

            // 5️⃣ Publish local tracks
            const localTracks = await window.LivekitClient.createLocalTracks({
                audio: true,
                video: { resolution: { width: 640, height: 480 }, frameRate: 15 }
            });

            for (const track of localTracks) {
                await currentRoom.localParticipant.publishTrack(track);
                handleTrack(track, currentRoom.localParticipant, true);
            }

            showMessage('roomMessage', `Connected to ${roomName}!`, 'success');
        }

        function subscribeToParticipantTracks(participant, isLocal) {
            participant.on(window.LivekitClient.ParticipantEvent.TrackSubscribed, track => {
                handleTrack(track, participant, isLocal);
            });

            participant.on(window.LivekitClient.ParticipantEvent.TrackUnsubscribed, track => {
                removeTrack(track, participant);
            });

            participant.trackPublications?.forEach(pub => {
                if (pub.track) {
                    handleTrack(pub.track, participant, isLocal);
                }
            });
        }

        function handleTrack(track, participant, isLocal) {
            const participantId = participant.sid || participant.identity;
            let wrapper = document.getElementById(`wrapper-${participantId}`);
            if (!wrapper) {
                wrapper = document.createElement('div');
                wrapper.id = `wrapper-${participantId}`;
                wrapper.className = 'participant-wrapper';
                const nameTag = document.createElement('div');
                nameTag.className = 'name-tag';
                nameTag.textContent = isLocal ? `${participant.identity} (You)` : participant.identity;
                wrapper.appendChild(nameTag);
                document.getElementById('videoContainer').appendChild(wrapper);
            }

            if (track.kind === 'video') {
                let videoEl = wrapper.querySelector('video');
                if (!videoEl) {
                    videoEl = document.createElement('video');
                    videoEl.autoplay = true;
                    videoEl.playsInline = true;
                    if (isLocal) videoEl.muted = true;
                    wrapper.insertBefore(videoEl, wrapper.firstChild);
                }
                track.attach(videoEl);
            } else if (track.kind === 'audio') {
                let audioEl = wrapper.querySelector('audio');
                if (!audioEl) {
                    audioEl = document.createElement('audio');
                    audioEl.autoplay = true;
                    if (isLocal) audioEl.muted = true;
                    wrapper.appendChild(audioEl);
                }
                track.attach(audioEl);
            }
        }

        function removeTrack(track, participant) {
            const participantId = participant.sid || participant.identity;
            const wrapper = document.getElementById(`wrapper-${participantId}`);
            if (!wrapper) return;

            const mediaEls = wrapper.querySelectorAll(track.kind);
            mediaEls.forEach(el => {
                track.detach(el);
                el.remove();
            });
        }

        function removeParticipantTracks(participant) {
            const participantId = participant.sid || participant.identity;
            const wrapper = document.getElementById(`wrapper-${participantId}`);
            if (wrapper) wrapper.remove();
        }

        function disconnectRoom() {
            if (currentRoom) {
                currentRoom.disconnect();
                document.getElementById('videoContainer').innerHTML = '';
                showMessage('roomMessage', 'Disconnected', 'info');
            }
        }

        function toggleMute() {
            if (!currentRoom) return;
            isMuted = !isMuted;
            currentRoom.localParticipant.audioTracks.forEach(pub => {
                pub.track.muted = isMuted;
            });
            document.getElementById('muteBtn').textContent = isMuted ? 'Unmute' : 'Mute';
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${type}">${message}</div>`;
            if (type === 'success') {
                setTimeout(() => { container.innerHTML = ''; }, 3000);
            }
        }
    </script>
</body>
</html>
