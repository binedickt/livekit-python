<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LiveKit Video Room</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        header {
            background: #333;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        main {
            padding: 1rem;
        }
        input, button {
            padding: 0.5rem;
            margin: 0.25rem;
        }
        video {
            width: 300px;
            height: auto;
            background: black;
            margin: 0.25rem;
        }
        .videos {
            display: flex;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <header>
        <h1>LiveKit Test Client</h1>
    </header>
    <main>
        <div>
            <label>Room:</label>
            <input id="roomName" type="text" value="test-room">
            <label>Name:</label>
            <input id="participantName" type="text" value="guest">
            <button id="joinBtn">Join Room</button>
        </div>
        <div class="videos" id="videoContainer"></div>
    </main>

    <!-- LiveKit JS SDK -->
    <script src="https://unpkg.com/livekit-client@1.15.13/dist/livekit-client.umd.js"></script>
    <script>
        const joinBtn = document.getElementById('joinBtn');
        const videoContainer = document.getElementById('videoContainer');

        // Check if LiveKit loaded properly
        console.log('LiveKit Client:', window.LivekitClient);

        // Check if getUserMedia is available
        console.log('getUserMedia available:', !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));

        function addVideoTrack(track) {
            const videoEl = document.createElement('video');
            videoEl.autoplay = true;
            videoEl.playsInline = true;
            videoEl.muted = true; // Add muted to prevent autoplay issues
            track.attach(videoEl);
            videoContainer.appendChild(videoEl);
        }

        joinBtn.addEventListener('click', async () => {
            const roomName = document.getElementById('roomName').value.trim();
            const participantName = document.getElementById('participantName').value.trim();

            if (!roomName || !participantName) {
                alert("Please enter both room and name");
                return;
            }

            try {
                // Check if we're on HTTPS or localhost
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    throw new Error('getUserMedia requires HTTPS or localhost');
                }

                // Fetch token from token server
                const resp = await fetch(`/token?room=${encodeURIComponent(roomName)}&username=${encodeURIComponent(participantName)}`);
                if (!resp.ok) throw new Error(`Token request failed with ${resp.status}`);

                const data = await resp.json();
                const token = data.token;

                console.log('Connecting to room with token...');

                // Connect to LiveKit
                const room = new window.LivekitClient.Room();
                await room.connect("ws://77.246.103.197:7880", token);

                console.log('Connected to room, getting local tracks...');

                // Get local tracks with more explicit options
                const tracks = await window.LivekitClient.createLocalTracks({
                    audio: {
                        deviceId: undefined,
                        echoCancellation: true,
                        noiseSuppression: true,
                    },
                    video: {
                        deviceId: undefined,
                        resolution: {
                            width: 640,
                            height: 480,
                        },
                        frameRate: 15,
                    }
                });

                console.log('Got local tracks:', tracks);

                for (const track of tracks) {
                    await room.localParticipant.publishTrack(track);
                    if (track.kind === 'video') {
                        addVideoTrack(track);
                    }
                }

                // When a new track is subscribed
                room.on(window.LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    console.log('Track subscribed:', track.kind, 'from', participant.identity);
                    if (track.kind === 'video') {
                        addVideoTrack(track);
                    }
                });

                // When a track is unsubscribed
                room.on(window.LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
                    console.log('Track unsubscribed:', track.kind, 'from', participant.identity);
                    track.detach().forEach(el => el.remove());
                });

                console.log("Successfully connected to room:", roomName);
                joinBtn.textContent = 'Connected!';
                joinBtn.disabled = true;

            } catch (err) {
                console.error('Full error:', err);
                alert("Error joining room: " + err.message);
            }
        });
    </script>
</body>
</html>