{
    admin off
    auto_https off
}

viken.stream:8443 {
    tls /etc/letsencrypt/live/viken.stream/fullchain.pem /etc/letsencrypt/live/viken.stream/privkey.pem

    # LiveKit WebRTC endpoints
    @livekit {
        path /rtc* /twirp* /livekit* /ws*
    }
    reverse_proxy @livekit livekit:7880 {
        header_up Upgrade websocket
        header_up Connection upgrade
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote}
    }

    # API endpoints
    @api {
        path /token* /login* /logout* /me* /rooms* /create-room* /health* /users*
    }
    reverse_proxy @api token-server:8000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote}
    }

    # Admin panel â€“ protect /admin and /admin.html
    @adminPath {
        path /admin /admin/*
    }
    reverse_proxy @adminPath token-server:8000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote}
    }

    @adminHtml {
        path /admin.html
    }
    reverse_proxy @adminHtml token-server:8000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote}
    }

    # Serve static files for everything else
    root * /srv/www
    file_server
}
