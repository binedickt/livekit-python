{
    admin off
    auto_https off
}

viken.stream:8443 {
    tls /etc/letsencrypt/live/viken.stream/fullchain.pem /etc/letsencrypt/live/viken.stream/privkey.pem

    # LiveKit WebRTC endpoints
    @livekit {
        path /rtc* /twirp* /livekit* /ws*
    }
    reverse_proxy @livekit livekit:7880 {
        header_up Upgrade websocket
        header_up Connection upgrade
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote}
        header_up X-Forwarded-For {http.request.remote}
        header_up X-Forwarded-Proto {http.request.scheme}
    }

    # API endpoints
    @api {
        path /token* /login* /logout* /me* /rooms* /create-room* /health* /users*
    }
    reverse_proxy @api token-server:8000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote}
        header_up X-Forwarded-For {http.request.remote}
        header_up X-Forwarded-Proto {http.request.scheme}
    }

    # Admin panel route
    @admin {
        path /admin
    }
    reverse_proxy @admin token-server:8000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote}
        header_up X-Forwarded-For {http.request.remote}
        header_up X-Forwarded-Proto {http.request.scheme}
    }

    # Block direct access to admin.html
    @blockAdmin {
        path /admin.html
    }
    respond @blockAdmin 403 {
        body "Access forbidden"
    }

    # Static files (excluding admin.html)
    root * /srv/www
    file_server {
        except /admin.html
    }
}